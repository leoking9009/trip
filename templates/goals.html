{% extends "base.html" %}

{% block title %}목표 관리 - 운동 관리 시스템{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-target"></i> 운동 목표 관리</h2>
    <a href="{{ url_for('add_goal') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> 새 목표 추가
    </a>
</div>

{% if goals %}
<div class="row">
    {% for goal in goals %}
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm {% if goal.is_achieved %}border-success{% endif %}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    {% if goal.is_achieved %}
                        <i class="bi bi-check-circle text-success"></i>
                    {% else %}
                        <i class="bi bi-target"></i>
                    {% endif %}
                    {{ goal.title }}
                </h5>
                <span class="badge 
                    {% if goal.goal_type == 'weekly' %}bg-primary
                    {% elif goal.goal_type == 'monthly' %}bg-info
                    {% else %}bg-warning{% endif %}">
                    {{ goal.goal_type }}
                </span>
            </div>
            <div class="card-body">
                {% if goal.description %}
                <p class="text-muted mb-3">{{ goal.description }}</p>
                {% endif %}

                <!-- 진행률 바 -->
                {% set progress = (goal.current_value / goal.target_value * 100) if goal.target_value > 0 else 0 %}
                {% set progress = 100 if progress > 100 else progress %}
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="small">진행률</span>
                        <span class="small">{{ "%.1f"|format(progress) }}%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar 
                            {% if goal.is_achieved %}bg-success
                            {% elif progress >= 80 %}bg-warning
                            {% else %}bg-primary{% endif %}" 
                             style="width: {{ progress }}%"></div>
                    </div>
                </div>

                <!-- 목표 정보 -->
                <div class="row text-center mb-3">
                    <div class="col-4">
                        <div class="border rounded p-2">
                            <div class="h6 mb-0">{{ goal.current_value }}</div>
                            <small class="text-muted">현재</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border rounded p-2">
                            <div class="h6 mb-0">{{ goal.target_value }}</div>
                            <small class="text-muted">목표</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border rounded p-2">
                            <div class="h6 mb-0">{{ goal.unit }}</div>
                            <small class="text-muted">단위</small>
                        </div>
                    </div>
                </div>

                <!-- 목표 날짜 -->
                {% if goal.target_date %}
                <div class="mb-3">
                    <small class="text-muted">
                        <i class="bi bi-calendar"></i> 
                        목표 날짜: {{ goal.target_date.strftime('%Y년 %m월 %d일') }}
                        {% set today_date = today() %}
                        {% set days_left = (goal.target_date - today_date).days %}
                        {% if days_left > 0 %}
                            ({{ days_left }}일 남음)
                        {% elif days_left == 0 %}
                            (오늘까지)
                        {% else %}
                            ({{ -days_left }}일 지남)
                        {% endif %}
                    </small>
                </div>
                {% endif %}

                <!-- 액션 버튼 -->
                <div class="d-flex gap-2">
                    {% if not goal.is_achieved %}
                    <button class="btn btn-sm btn-outline-primary" 
                            onclick="updateProgress({{ goal.id }})">
                        <i class="bi bi-plus-circle"></i> 진행률 업데이트
                    </button>
                    {% endif %}
                    
                    <a href="{{ url_for('edit_goal', id=goal.id) }}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-pencil"></i> 수정
                    </a>
                    
                    {% if goal.is_achieved %}
                    <span class="btn btn-sm btn-success disabled">
                        <i class="bi bi-trophy"></i> 달성 완료!
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- 목표 요약 통계 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-graph-up"></i> 목표 달성 현황</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <h4 class="text-primary mb-1">{{ goals|length }}</h4>
                            <small class="text-muted">전체 목표</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <h4 class="text-success mb-1">{{ goals|selectattr('is_achieved', 'equalto', true)|list|length }}</h4>
                            <small class="text-muted">달성 완료</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <h4 class="text-warning mb-1">
                                {{ goals|selectattr('is_achieved', 'equalto', false)|list|length }}
                            </h4>
                            <small class="text-muted">진행 중</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            {% set achieved_goals = goals|selectattr('is_achieved', 'equalto', true)|list %}
                            {% set achievement_rate = (achieved_goals|length / goals|length * 100) if goals|length > 0 else 0 %}
                            <h4 class="text-info mb-1">{{ "%.0f"|format(achievement_rate) }}%</h4>
                            <small class="text-muted">달성률</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="text-center py-5">
    <i class="bi bi-bullseye text-muted" style="font-size: 4rem;"></i>
    <h4 class="text-muted mt-3">설정된 목표가 없습니다</h4>
    <p class="text-muted">운동 목표를 설정하고 체계적으로 관리해보세요!</p>
    <a href="{{ url_for('add_goal') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> 첫 목표 설정하기
    </a>
</div>
{% endif %}

<!-- 진행률 업데이트 모달 -->
<div class="modal fade" id="progressModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">진행률 업데이트</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="progressForm" method="POST">
                    <input type="hidden" id="goalId" name="goal_id">
                    <div class="mb-3">
                        <label for="currentValue" class="form-label">현재 달성값</label>
                        <input type="number" class="form-control" id="currentValue" name="current_value" 
                               step="0.1" required>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">메모 (선택사항)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2" 
                                  placeholder="오늘의 성과나 느낀점을 기록하세요"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="submitProgress()">업데이트</button>
            </div>
        </div>
    </div>
</div>

<script>
function updateProgress(goalId) {
    document.getElementById('goalId').value = goalId;
    document.getElementById('progressForm').action = `/goals/update-progress/${goalId}`;
    const modal = new bootstrap.Modal(document.getElementById('progressModal'));
    modal.show();
}

function submitProgress() {
    const form = document.getElementById('progressForm');
    form.submit();
}



// 목표 타입별 필터링 (향후 구현)
function filterGoals(type) {
    console.log('필터링:', type);
}
</script>
{% endblock %}
