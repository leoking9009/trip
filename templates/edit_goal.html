{% extends "base.html" %}

{% block title %}목표 수정 - 운동 관리 시스템{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-pencil"></i> 운동 목표 수정</h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label for="title" class="form-label">목표 제목 *</label>
                        <input type="text" class="form-control" id="title" name="title" required
                               value="{{ goal.title }}">
                        <div class="form-text">구체적이고 명확한 목표를 설정하세요.</div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">목표 설명</label>
                        <textarea class="form-control" id="description" name="description" rows="3">{{ goal.description or '' }}</textarea>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="goal_type" class="form-label">목표 기간 *</label>
                            <select class="form-select" id="goal_type" name="goal_type" required>
                                <option value="">선택하세요</option>
                                <option value="weekly" {% if goal.goal_type == 'weekly' %}selected{% endif %}>주간 목표</option>
                                <option value="monthly" {% if goal.goal_type == 'monthly' %}selected{% endif %}>월간 목표</option>
                                <option value="yearly" {% if goal.goal_type == 'yearly' %}selected{% endif %}>연간 목표</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="target_date" class="form-label">목표 달성 날짜 *</label>
                            <input type="date" class="form-control" id="target_date" name="target_date" 
                                   value="{{ goal.target_date.strftime('%Y-%m-%d') }}" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="target_value" class="form-label">목표 수치 *</label>
                            <input type="number" class="form-control" id="target_value" name="target_value" 
                                   step="0.1" required value="{{ goal.target_value }}">
                        </div>
                        <div class="col-md-6">
                            <label for="unit" class="form-label">단위 *</label>
                            <select class="form-select" id="unit" name="unit" required>
                                <option value="">선택하세요</option>
                                <option value="회" {% if goal.unit == '회' %}selected{% endif %}>회 (운동 횟수)</option>
                                <option value="분" {% if goal.unit == '분' %}selected{% endif %}>분 (운동 시간)</option>
                                <option value="kg" {% if goal.unit == 'kg' %}selected{% endif %}>kg (체중/무게)</option>
                                <option value="km" {% if goal.unit == 'km' %}selected{% endif %}>km (거리)</option>
                                <option value="일" {% if goal.unit == '일' %}selected{% endif %}>일 (연속 일수)</option>
                                <option value="세트" {% if goal.unit == '세트' %}selected{% endif %}>세트 (운동 세트)</option>
                                <option value="개" {% if goal.unit == '개' %}selected{% endif %}>개 (개수)</option>
                            </select>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('goals') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> 취소
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> 수정 저장
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 목표 진행 상황 -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-info-circle"></i> 현재 진행 상황</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>생성일:</strong> {{ goal.created_at.strftime('%Y년 %m월 %d일') }}</p>
                        <p class="mb-1"><strong>현재 달성값:</strong> {{ goal.current_value }} {{ goal.unit }}</p>
                        <p class="mb-1"><strong>목표값:</strong> {{ goal.target_value }} {{ goal.unit }}</p>
                    </div>
                    <div class="col-md-6">
                        {% set progress = (goal.current_value / goal.target_value * 100) if goal.target_value > 0 else 0 %}
                        {% set progress = 100 if progress > 100 else progress %}
                        <p class="mb-1"><strong>진행률:</strong> {{ "%.1f"|format(progress) }}%</p>
                        <div class="progress mb-2">
                            <div class="progress-bar 
                                {% if goal.is_achieved %}bg-success
                                {% elif progress >= 80 %}bg-warning
                                {% else %}bg-primary{% endif %}" 
                                 style="width: {{ progress }}%"></div>
                        </div>
                        <p class="mb-1">
                            <strong>상태:</strong> 
                            {% if goal.is_achieved %}
                                <span class="badge bg-success">달성 완료</span>
                            {% else %}
                                <span class="badge bg-primary">진행 중</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 진행률 업데이트 -->
        {% if not goal.is_achieved %}
        <div class="card mt-4 border-success">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="bi bi-arrow-up-circle"></i> 진행률 업데이트</h6>
            </div>
            <div class="card-body">
                <form action="{{ url_for('update_goal_progress', id=goal.id) }}" method="POST" class="row g-3">
                    <div class="col-md-8">
                        <label for="current_value" class="form-label">현재 달성값</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="current_value" name="current_value" 
                                   step="0.1" value="{{ goal.current_value }}" required>
                            <span class="input-group-text">{{ goal.unit }}</span>
                        </div>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-check-circle"></i> 업데이트
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- 위험 영역 -->
        <div class="card mt-4 border-danger">
            <div class="card-header bg-danger text-white">
                <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> 위험 영역</h6>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">목표를 삭제하면 모든 진행 기록이 사라집니다. 이 작업은 되돌릴 수 없습니다.</p>
                <a href="{{ url_for('delete_goal', id=goal.id) }}" 
                   class="btn btn-outline-danger"
                   onclick="return confirm('정말로 이 목표를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')">
                    <i class="bi bi-trash"></i> 목표 삭제
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// 폼 유효성 검사
document.querySelector('form').addEventListener('submit', function(e) {
    const targetDate = new Date(document.getElementById('target_date').value);
    const today = new Date();
    
    if (targetDate <= today) {
        e.preventDefault();
        alert('목표 날짜는 오늘 이후로 설정해주세요.');
    }
});

// 목표 기간에 따른 권장 날짜 설정
document.getElementById('goal_type').addEventListener('change', function() {
    const goalType = this.value;
    const today = new Date();
    let suggestedDate = new Date(today);
    
    if (goalType === 'weekly') {
        suggestedDate.setDate(today.getDate() + 7);
    } else if (goalType === 'monthly') {
        suggestedDate.setMonth(today.getMonth() + 1);
    } else if (goalType === 'yearly') {
        suggestedDate.setFullYear(today.getFullYear() + 1);
    }
    
    if (goalType) {
        const currentDate = document.getElementById('target_date').value;
        if (!currentDate || confirm('목표 기간이 변경되었습니다. 목표 날짜를 자동으로 조정하시겠습니까?')) {
            document.getElementById('target_date').value = suggestedDate.toISOString().split('T')[0];
        }
    }
});
</script>
{% endblock %}
