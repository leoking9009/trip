{% extends "base.html" %}

{% block title %}운동 달력 - 운동 관리 시스템{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-calendar3"></i> 운동 달력</h2>
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary" onclick="previousMonth()">
            <i class="bi bi-chevron-left"></i>
        </button>
        <button type="button" class="btn btn-outline-primary" id="currentMonth"></button>
        <button type="button" class="btn btn-outline-primary" onclick="nextMonth()">
            <i class="bi bi-chevron-right"></i>
        </button>
    </div>
</div>

<!-- 달력 -->
<div class="card shadow-sm mb-4">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-borderless mb-0">
                <thead class="bg-light">
                    <tr class="text-center">
                        <th class="py-3 text-danger">일</th>
                        <th class="py-3">월</th>
                        <th class="py-3">화</th>
                        <th class="py-3">수</th>
                        <th class="py-3">목</th>
                        <th class="py-3">금</th>
                        <th class="py-3 text-primary">토</th>
                    </tr>
                </thead>
                <tbody id="calendarBody">
                    <!-- 달력 내용이 JavaScript로 동적 생성됩니다 -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 월간 통계 -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> 이번 달 운동 현황</h5>
            </div>
            <div class="card-body">
                <div class="row text-center mb-3">
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <h4 class="text-primary mb-1" id="monthlyWorkouts">0</h4>
                            <small class="text-muted">운동 일수</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <h4 class="text-success mb-1" id="monthlyHours">0</h4>
                            <small class="text-muted">총 시간</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <h4 class="text-info mb-1" id="avgDuration">0</h4>
                            <small class="text-muted">평균 시간</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <h4 class="text-warning mb-1" id="consistency">0%</h4>
                            <small class="text-muted">일관성</small>
                        </div>
                    </div>
                </div>
                
                <!-- 주별 운동 분포 차트 -->
                <div class="chart-container" style="height: 200px;">
                    <canvas id="weeklyDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-award"></i> 이번 달 성과</h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex align-items-center border-0 px-0">
                        <i class="bi bi-fire text-warning me-2 fs-5"></i>
                        <div>
                            <div class="fw-bold">최장 연속 기록</div>
                            <small class="text-muted">7일 연속 운동</small>
                        </div>
                    </div>
                    <div class="list-group-item d-flex align-items-center border-0 px-0">
                        <i class="bi bi-graph-up text-success me-2 fs-5"></i>
                        <div>
                            <div class="fw-bold">최고 운동 시간</div>
                            <small class="text-muted">120분 (12/15)</small>
                        </div>
                    </div>
                    <div class="list-group-item d-flex align-items-center border-0 px-0">
                        <i class="bi bi-calendar-check text-primary me-2 fs-5"></i>
                        <div>
                            <div class="fw-bold">가장 활발한 요일</div>
                            <small class="text-muted">화요일 (5회)</small>
                        </div>
                    </div>
                    <div class="list-group-item d-flex align-items-center border-0 px-0">
                        <i class="bi bi-trophy text-warning me-2 fs-5"></i>
                        <div>
                            <div class="fw-bold">목표 달성률</div>
                            <small class="text-muted">85% 완료</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 운동 계획 추가 -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-calendar-plus"></i> 운동 계획 추가</h5>
            </div>
            <div class="card-body">
                <form class="row g-3" onsubmit="addWorkoutPlan(event)">
                    <div class="col-md-3">
                        <label for="planDate" class="form-label">날짜</label>
                        <input type="date" class="form-control" id="planDate" required>
                    </div>
                    <div class="col-md-3">
                        <label for="planTime" class="form-label">시간</label>
                        <input type="time" class="form-control" id="planTime">
                    </div>
                    <div class="col-md-4">
                        <label for="planNote" class="form-label">운동 계획</label>
                        <input type="text" class="form-control" id="planNote" 
                               placeholder="예: 가슴 운동, 유산소 30분">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-plus"></i> 추가
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 운동 상세 보기 모달 -->
<div class="modal fade" id="workoutDetailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 운동 상세 내용이 들어갈 자리 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <a href="#" class="btn btn-primary" id="editWorkoutBtn">수정하기</a>
            </div>
        </div>
    </div>
</div>

<style>
.calendar-day {
    height: 120px;
    vertical-align: top;
    position: relative;
    cursor: pointer;
    transition: background-color 0.2s;
}

.calendar-day:hover {
    background-color: #f8f9fa;
}

.calendar-day.other-month {
    color: #ccc;
    background-color: #f8f9fa;
}

.calendar-day.today {
    background-color: #e3f2fd;
    font-weight: bold;
}

.calendar-day.has-workout {
    background-color: #e8f5e8;
}

.workout-indicator {
    position: absolute;
    bottom: 2px;
    left: 2px;
    right: 2px;
}

.workout-badge {
    font-size: 0.7rem;
    margin: 1px;
}

.date-number {
    font-weight: bold;
    margin-bottom: 4px;
}

.plan-item {
    background: #fff3cd;
    border: 1px solid #ffeeba;
    border-radius: 3px;
    padding: 2px 4px;
    margin: 1px 0;
    font-size: 0.7rem;
}

.workout-item {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 3px;
    padding: 2px 4px;
    margin: 1px 0;
    font-size: 0.7rem;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let currentDate = new Date();
let workoutData = {{ calendar_data|safe }};
let workoutPlans = {}; // 계획된 운동들

function initCalendar() {
    updateCalendarDisplay();
    updateMonthlyStats();
    createWeeklyChart();
}

function updateCalendarDisplay() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    // 월 표시 업데이트
    document.getElementById('currentMonth').textContent = 
        `${year}년 ${month + 1}월`;
    
    // 달력 생성
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const calendarBody = document.getElementById('calendarBody');
    calendarBody.innerHTML = '';
    
    let date = new Date(startDate);
    
    for (let week = 0; week < 6; week++) {
        const row = document.createElement('tr');
        
        for (let day = 0; day < 7; day++) {
            const cell = document.createElement('td');
            cell.className = 'calendar-day p-2';
            
            const dateStr = date.toISOString().split('T')[0];
            const isCurrentMonth = date.getMonth() === month;
            const isToday = date.toDateString() === new Date().toDateString();
            
            if (!isCurrentMonth) {
                cell.classList.add('other-month');
            }
            if (isToday) {
                cell.classList.add('today');
            }
            if (workoutData[dateStr]) {
                cell.classList.add('has-workout');
            }
            
            // 날짜 번호
            const dateDiv = document.createElement('div');
            dateDiv.className = 'date-number';
            dateDiv.textContent = date.getDate();
            cell.appendChild(dateDiv);
            
            // 운동 기록 표시
            if (workoutData[dateStr]) {
                workoutData[dateStr].forEach(workout => {
                    const workoutDiv = document.createElement('div');
                    workoutDiv.className = 'workout-item';
                    workoutDiv.textContent = `${workout.duration}분`;
                    workoutDiv.title = workout.notes || '운동 완료';
                    cell.appendChild(workoutDiv);
                });
            }
            
            // 운동 계획 표시
            if (workoutPlans[dateStr]) {
                workoutPlans[dateStr].forEach(plan => {
                    const planDiv = document.createElement('div');
                    planDiv.className = 'plan-item';
                    planDiv.textContent = plan.note;
                    planDiv.title = `계획: ${plan.time || ''} ${plan.note}`;
                    cell.appendChild(planDiv);
                });
            }
            
            // 클릭 이벤트
            cell.addEventListener('click', () => showDayDetail(dateStr, date));
            
            row.appendChild(cell);
            date.setDate(date.getDate() + 1);
        }
        
        calendarBody.appendChild(row);
        
        // 6주째가 모두 다른 달이면 중단
        if (week === 5 && date.getMonth() !== month) {
            break;
        }
    }
}

function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    updateCalendarDisplay();
    updateMonthlyStats();
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    updateCalendarDisplay();
    updateMonthlyStats();
}

function updateMonthlyStats() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    let workoutDays = 0;
    let totalMinutes = 0;
    
    // 현재 월의 운동 데이터 계산
    Object.keys(workoutData).forEach(dateStr => {
        const date = new Date(dateStr);
        if (date.getFullYear() === year && date.getMonth() === month) {
            workoutDays++;
            workoutData[dateStr].forEach(workout => {
                totalMinutes += workout.duration || 0;
            });
        }
    });
    
    const avgDuration = workoutDays > 0 ? Math.round(totalMinutes / workoutDays) : 0;
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const consistency = Math.round((workoutDays / daysInMonth) * 100);
    
    document.getElementById('monthlyWorkouts').textContent = workoutDays;
    document.getElementById('monthlyHours').textContent = Math.round(totalMinutes / 60 * 10) / 10 + 'h';
    document.getElementById('avgDuration').textContent = avgDuration + '분';
    document.getElementById('consistency').textContent = consistency + '%';
}

function createWeeklyChart() {
    const ctx = document.getElementById('weeklyDistributionChart').getContext('2d');
    
    // 샘플 데이터 (실제로는 서버에서 가져와야 함)
    const weeklyData = [2, 3, 4, 3, 2, 1, 0]; // 주별 운동 일수
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['1주차', '2주차', '3주차', '4주차'],
            datasets: [{
                label: '운동 일수',
                data: weeklyData.slice(0, 4),
                backgroundColor: '#667eea',
                borderColor: '#667eea',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 7
                }
            }
        }
    });
}

function showDayDetail(dateStr, date) {
    const modal = new bootstrap.Modal(document.getElementById('workoutDetailModal'));
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    
    modalTitle.textContent = `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
    
    let content = '';
    
    // 운동 기록 표시
    if (workoutData[dateStr]) {
        content += '<h6><i class="bi bi-check-circle text-success"></i> 완료된 운동</h6>';
        workoutData[dateStr].forEach(workout => {
            content += `
                <div class="alert alert-success">
                    <strong>운동 시간:</strong> ${workout.duration}분<br>
                    ${workout.notes ? `<strong>메모:</strong> ${workout.notes}` : ''}
                </div>
            `;
        });
    }
    
    // 운동 계획 표시
    if (workoutPlans[dateStr]) {
        content += '<h6><i class="bi bi-calendar-event text-primary"></i> 계획된 운동</h6>';
        workoutPlans[dateStr].forEach(plan => {
            content += `
                <div class="alert alert-info">
                    ${plan.time ? `<strong>시간:</strong> ${plan.time}<br>` : ''}
                    <strong>계획:</strong> ${plan.note}
                </div>
            `;
        });
    }
    
    if (!content) {
        content = '<p class="text-muted">이 날에는 운동 기록이나 계획이 없습니다.</p>';
    }
    
    modalBody.innerHTML = content;
    modal.show();
}

function addWorkoutPlan(event) {
    event.preventDefault();
    
    const date = document.getElementById('planDate').value;
    const time = document.getElementById('planTime').value;
    const note = document.getElementById('planNote').value;
    
    if (!date || !note) {
        alert('날짜와 운동 계획을 입력해주세요.');
        return;
    }
    
    if (!workoutPlans[date]) {
        workoutPlans[date] = [];
    }
    
    workoutPlans[date].push({ time, note });
    
    // 폼 초기화
    document.getElementById('planDate').value = '';
    document.getElementById('planTime').value = '';
    document.getElementById('planNote').value = '';
    
    // 달력 업데이트
    updateCalendarDisplay();
    
    alert('운동 계획이 추가되었습니다!');
}

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', initCalendar);
</script>
{% endblock %}
